<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
  <title>购物网站</title>
  <!-- 添加 data-cfasync属性禁用 Cloudflare Rocket Loader -->
  <script data-cfasync="false">
    // 创建自定义日志功能
    function createLogger() {
      var logDiv = document.createElement('div');
      logDiv.style.position = 'fixed';
      logDiv.style.bottom = '0';
      logDiv.style.left = '0';
      logDiv.style.right = '0';
      logDiv.style.background = 'rgba(0,0,0,0.7)';
      logDiv.style.color = 'white';
      logDiv.style.padding = '10px';
      logDiv.style.maxHeight = '150px';
      logDiv.style.overflowY = 'auto';
      logDiv.style.zIndex = '9999';
      logDiv.style.fontSize = '12px';
      document.body.appendChild(logDiv);
      return function(msg) {
        console.log(msg);
        var p = document.createElement('p');
        p.textContent = new Date().toTimeString().split(' ')[0] + ': ' + msg;
        logDiv.appendChild(p);
        logDiv.scrollTop = logDiv.scrollHeight;
      };
    }
    
    // 等页面加载完再初始化
    document.addEventListener('DOMContentLoaded', function() {
      var log = createLogger();
      log('页面加载完成');
      
      // 获取元素
      var loginBtn = document.getElementById('loginBtn');
      var userInfo = document.getElementById('userInfo');
      var username = document.getElementById('username');
      // 检查登录状态
      var token = localStorage.getItem('token');
      if (token) {
        log('已检测到登录状态');
        loginBtn.style.display = 'none';
        userInfo.style.display = 'block';
        username.textContent = localStorage.getItem('username') || '用户';
      } else {
        log('未登录状态');
        loginBtn.style.display = 'block';
        userInfo.style.display = 'none';
      }
      
      // 监听SDK就绪
      document.addEventListener('AppSDKReady', function() {
        log('AppSDK已加载');
      });
      
      // 设置登录按钮事件
      loginBtn.addEventListener('click', function() {
        log('点击登录按钮');
        if (window.AppSDK) {
          try {
            log('调用AppSDK.openLogin()');
            window.AppSDK.openLogin();
            
            // 设置登录回调
            window.AppSDK.setLoginCallback(function(data) {
              log('收到登录成功回调: ' + JSON.stringify(data));
              // 保存数据
              if (data.token) {
                localStorage.setItem('token', data.token);}
              
              if (data.userInfo) {
                localStorage.setItem('username', data.userInfo.username);username.textContent = data.userInfo.username;
              }
              
              // 更新UI
              loginBtn.style.display = 'none';
              userInfo.style.display = 'block';
            });
          } catch (e) {
            log('调用SDK出错: ' + e.message);
          }
        } else {
          log('未检测到AppSDK');
          alert('请在App内打开此页面');
        }
      });
      // 监听消息事件
      window.addEventListener('message', function(event) {
        log('收到消息: ' + JSON.stringify(event.data));
        var data = event.data;
        
        if (data && data.action === 'loginSuccess') {
          log('处理登录成功消息');
          
          // 保存数据
          if ( {
            localStorage.setItem('token', data.token);
          }
          
          if (data.userInfo) {
            localStorage.setItem('username', data.userInfo.username);
            username.textContent = data.userInfo.username;
          }
          
          // 更新UI
          loginBtn.style.display = 'none';
          userInfo.style.display = 'block';
        }
      });
      // 设置超时检查
      setTimeout(function() {
        if (!window.AppSDK) {
          log('AppSDK加载超时');
        }
      }, 3000);
    });
  </script>
</head>
<body>
  <div id="app">
    <h1>购物网站</h1>
    <button id="loginBtn" style="padding: 10px 20px; background-color: #007AFF; color: white; border: none; border-radius: 4px; margin: 20px 0;">登录</button>
    <div id="userInfo" style="display: none;">欢迎您，<span id="username"></span>
    </div></div>
</body>
</html>
