<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
  <title>购物网站</title>
  <style>
    #logArea {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      max-height: 150px;
      overflow-y: auto;
      font-size: 12px;
      z-index: 9999;
    }
    #logArea p {
      margin: 2px 0;
      user-select: text;
      -webkit-user-select: text;
    }
    #copyLogs {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #007AFF;
      color: white;
      border: none;
      border-radius: 3px;
      padding: 3px 8px;
      font-size: 10px;
      cursor: pointer;
    }
    #app {
      padding: 20px;
      font-family: Arial, sans-serif;
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    button {
      background-color: #007AFF;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }
    #userInfo {
      margin-top: 20px;
      padding: 15px;
      background-color: #f5f5f5;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>购物网站</h1>
    <button id="loginBtn">登录</button>
    <div id="userInfo" style="display: none;">欢迎您，<span id="username"></span></div>
  </div>
  
  <!-- 添加日志区域 -->
  <div id="logArea">
    <button id="copyLogs">复制日志</button>
  </div>
  
  <script>
    // 日志存储
    var logMessages = [];
    
    // 日志函数
    function log(message) {
      var timestamp = new Date().toTimeString().split(' ')[0];
      var logMessage = timestamp + ': ' + message;
      
      console.log(logMessage);
      logMessages.push(logMessage);
      
      var logArea = document.getElementById('logArea');
      var entry = document.createElement('p');
      entry.textContent = logMessage;
      logArea.appendChild(entry);
      logArea.scrollTop = logArea.scrollHeight;
    }
    
    // 复制日志功能
    document.getElementById('copyLogs').addEventListener('click', function() {
      var logText = logMessages.join('\n');
      navigator.clipboard.writeText(logText).then(function() {
        alert('日志已复制到剪贴板');
      }).catch(function(err) {
        // 备用复制方法
        var textarea = document.createElement('textarea');
        textarea.value = logText;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        alert('日志已复制到剪贴板（备用方法）');
      });
    });
    
    // 初始化页面
    function initPage() {
      log('初始化页面');
      var loginBtn = document.getElementById('loginBtn');
      var userInfo = document.getElementById('userInfo');
      var username = document.getElementById('username');
      
      // 检查登录状态
      var token = localStorage.getItem('token');
      if (token) {
        log('已登录状态');
        loginBtn.style.display = 'none';
        userInfo.style.display = 'block';
        username.textContent = localStorage.getItem('username') || '用户';
      } else {
        log('未登录状态');
        loginBtn.style.display = 'block';
        userInfo.style.display = 'none';
      }
      
      // 绑定登录按钮点击事件
      loginBtn.addEventListener('click', function() {
        log('点击登录按钮');
        
        // 使用 postMessage 发送消息
        try {
          log('使用 postMessage 发送登录请求');
          window.parent.postMessage({
            action: 'openLogin'
          }, '*');
          log('已发送登录请求');
        } catch(e) {
          log('发送登录请求失败: ' + e.message);
        }
      });
      
      // 监听消息
      window.addEventListener('message', function(event) {
        log('收到消息: ' + JSON.stringify(event.data));
        var data = event.data;
        
        if (data && data.action === 'loginSuccess') {
          log('收到登录成功消息');
          // 保存登录信息
          if (data.token) {
            localStorage.setItem('token', data.token);
          }
          
          if (data.userInfo) {
            localStorage.setItem('username', data.userInfo.username);
            username.textContent = data.userInfo.username;
          }
          
          // 更新UI
          loginBtn.style.display = 'none';
          userInfo.style.display = 'block';
        }
      });
    }
    
    // 页面加载完成
    document.addEventListener('DOMContentLoaded', function() {
      log('页面加载完成');
      initPage();
      
      // 添加调试信息
      log('浏览器信息: ' + navigator.userAgent);
      log('当前URL: ' + window.location.href);
    });
  </script>
</body>
</html>
