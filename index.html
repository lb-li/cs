<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
  <title>购物网站</title>
  <!--禁用Cloudflare的Rocket Loader -->
  <meta name="cf-2fa-verify" content="no-rocket">
</head>
<body>
  <div id="app">
    <h1>购物网站</h1>
    <button id="loginBtn">登录</button>
    <div id="userInfo" style="display: none;">欢迎您，<span id="username"></span></div>
  </div>
  <!-- 添加日志区域 -->
  <div id="logArea" style="position:fixed; bottom:0; left:0; right:0; background:rgba(0,0,0,0.7); color:white; padding:10px; max-height:150px; overflow-y:auto; font-size:12px; z-index:9999;"></div>
  
  <!-- 使用data-cfasync属性禁用Rocket Loader -->
  <script data-cfasync="false">
    // 日志函数
    function log(message) {
      console.log(message);
      var logArea = document.getElementById('logArea');
      var entry = document.createElement('p');
      entry.style.margin = '2px 0';
      entry.textContent = new Date().toTimeString().split(' ')[0] + ': ' + message;
      logArea.appendChild(entry);
      logArea.scrollTop = logArea.scrollHeight;
    }
    
    // 检查是否在App环境中
    function isInAppEnv() {
      var hasSDK = typeof window.AppSDK !== 'undefined';
      log('检查App环境: ' + (hasSDK ? '是' : '否') + ' (window.AppSDK: ' + typeof window.AppSDK + ')');
      return hasSDK;
    }
    
    // 初始化页面
    function initPage() {
      log('初始化页面');
      var loginBtn = document.getElementById('loginBtn');
      var userInfo = document.getElementById('userInfo');
      var username = document.getElementById('username');
      
      // 检查登录状态
      var token = localStorage.getItem('token');
      if (token) {
        log('已登录状态');
        loginBtn.style.display = 'none';
        userInfo.style.display = 'block';
        username.textContent = localStorage.getItem('username') || '用户';
      } else {
        log('未登录状态');
        loginBtn.style.display = 'block';
        userInfo.style.display = 'none';
      }
      
      // 绑定登录按钮点击事件
      loginBtn.addEventListener('click', function() {
        log('点击登录按钮');
        if (isInAppEnv()) {
          try {
            log('调用AppSDK.openLogin()');
            window.AppSDK.openLogin();
            log('已发送打开登录请求');
            
            // 设置登录回调
            window.AppSDK.setLoginCallback(function(data) {
              log('收到登录回调数据: ' + JSON.stringify(data));
              if (data.token) {
                localStorage.setItem('token', data.token);
              }
              if (data.userInfo) {
                localStorage.setItem('username', data.userInfo.username);
                username.textContent = data.userInfo.username;
              }
              // 更新界面
              loginBtn.style.display = 'none';
              userInfo.style.display = 'block';
            });
          } catch (e) {
            log('调用SDK出错: ' + e.message);
          }
        } else {
          log('非App环境，无法调用登录');
          alert('请在App中打开此页面');
        }
      });
    }
    
    // 监听消息
    window.addEventListener('message', function(event) {
      log('收到消息: ' + JSON.stringify(event.data));
      var data = event.data;
      
      if (data && data.action === 'loginSuccess') {
        log('收到登录成功消息');
        // 保存登录信息
        if (data.token) {
          localStorage.setItem('token', data.token);
        }
        
        if (data.userInfo) {
          localStorage.setItem('username', data.userInfo.username);
          document.getElementById('username').textContent = data.userInfo.username;
        }
        
        // 更新UI
        document.getElementById('loginBtn').style.display = 'none';
        document.getElementById('userInfo').style.display = 'block';
        
        // 如果有回调函数则执行
        if (window.loginCallback) {
          window.loginCallback(data);
        }
      }
    });
    
    // 创建一个全局变量来跟踪SDK是否已初始化
    window.sdkInitialized = false;
    
    // 监听SDK注入失败事件
    document.addEventListener('AppSDKInjectFailed', function() {
      log('收到AppSDK注入失败事件，尝试使用备用方法');
      // 这里可以实现备用通信方法
    });
    
    // 页面加载完成
    document.addEventListener('DOMContentLoaded', function() {
      log('页面加载完成');
      
      // 增加更长的等待时间
      var maxWaitTime = 8000; // 8秒
      var checkInterval = 500; // 每500毫秒检查一次
      var elapsedTime = 0;
      
      function checkSDK() {
        if (isInAppEnv()) {
          log('检测到AppSDK，初始化页面');
          if (!window.sdkInitialized) {
            window.sdkInitialized = true;
            initPage();
          }
          return;
        }
        
        elapsedTime += checkInterval;
        if (elapsedTime >= maxWaitTime) {
          log('AppSDK加载超时，尝试初始化页面');
          initPage();
        } else {
          setTimeout(checkSDK, checkInterval);
        }
      }
      
      // 开始检查
      log('等待AppSDK注入...');
      checkSDK();
      
      // 监听SDK就绪事件
      document.addEventListener('AppSDKReady', function() {
        log('收到AppSDKReady事件');
        if (!isInAppEnv()) {
          log('奇怪，收到了AppSDKReady事件但AppSDK不存在');
        } else {
          log('AppSDK加载完成');
          if (!window.sdkInitialized) {
            window.sdkInitialized = true;
            initPage();
          }
        }
      });
      
      // 添加全局错误处理
      window.onerror = function(message, source, lineno, colno, error) {
        log('全局错误: ' + message + ' at ' + source + ':' + lineno + ':' + colno);
        return false;
      };
    });
    
    // 添加一个备用方法，以防AppSDK注入失败
  window.manuallyInitSDK = function() {
  log('手动初始化SDK');
  if (!window.AppSDK) {
    window.AppSDK = {
      openLogin: function() {
        log('使用备用方法打开登录');
        
        // 尝试通过iframe postMessage通信
        try {
          log('尝试通过postMessage发送登录请求');
          window.parent.postMessage({
            action: 'openLogin'
          }, '*');
          
          // 尝试触发UniApp事件
          var event = new CustomEvent('UniAppJSBridgeReady', {
            detail: {
              data: [{
                action: 'openLogin'
              }]
            }
          });
          document.dispatchEvent(event);
          log('已发送登录请求');
        } catch(e) {
          log('发送登录请求失败: ' + e.message);
          alert('无法连接到App，请使用App内置的登录功能');
        }
      },
      setLoginCallback: function(callback) {
        window.loginCallback = callback;
        log('已设置登录回调');
      }
    };
    log('备用SDK已初始化');
    document.dispatchEvent(new CustomEvent('AppSDKReady'));
  }
};
    
    // 如果5秒后仍未初始化，尝试手动初始化
    setTimeout(function() {
      if (!isInAppEnv() && !window.sdkInitialized) {
        log('长时间未检测到AppSDK，尝试手动初始化');
        window.manuallyInitSDK();
      }
    }, 5000);
  </script>
</body>
</html>
